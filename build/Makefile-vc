# fserv v0.17 makefile

OSTYPE = wint
OS = win
FSV_BIN = fserv.exe
SO = dll
FSV_SRCDIR = ../src
ARCH = 64
TARGET = x64
WVER = 0x0600
VER =
RUNDIR=../run

FFOS = ../../ffos
FFOS_OBJ_DIR = ./ff-obj

FF = ../../ff
FF_OBJ_DIR = $(FFOS_OBJ_DIR)
ZLIB = $(FF)/3pt/z/zdll-$(OS)$(ARCH).lib
ZDLL = $(FF)/3pt/z/zlib1-$(OS)$(ARCH).dll
LIBZSO = zlib1.dll

CP = cp -u -v -p
PACK = zip -9 -r -v

C = cl.exe
O = /Fo
LD = link.exe
O_LD = /OUT:
SHARED = /DLL
OPT = /O2
DBG = /DNDEBUG


override CFLAGS += \
	/DWIN32 /D_CONSOLE /D_UNICODE /DUNICODE $(DBG) \
	/D_WIN32_WINDOWS=$(WVER) /D_WIN32_WINNT=$(WVER) /DWINVER=$(WVER) \
	/I$(FSV_SRCDIR) /I$(FF) /I$(FFOS) \
	$(OPT) /Oi /GL /MT /Gy /W3 /WX /nologo /c /Zi /GF /TC

override LDFLAGS += /INCREMENTAL:NO /NOLOGO /DEBUG /SUBSYSTEM:CONSOLE \
	/OPT:REF /OPT:ICF /LTCG /DYNAMICBASE
DEF_LIBS = kernel32.lib user32.lib ws2_32.lib

FSV_LDFLAGS = \
	/MANIFEST /MANIFESTFILE:".\$(FSV_BIN).intermediate.manifest" /MANIFESTUAC:"level='asInvoker' uiAccess='false'" \
	/PDB:".\fserv.pdb" \
	$(DEF_LIBS)


MOD_LOG_LDFLAGS = /PDB:".\log.pdb" $(DEF_LIBS)

MOD_CACHE_LDFLAGS = /PDB:".\cache.pdb" $(DEF_LIBS)

MOD_NET_LDFLAGS = /PDB:".\net.pdb" $(DEF_LIBS)

MOD_HTTP_LDFLAGS = /PDB:".\http.pdb" $(DEF_LIBS)

MOD_HTTPPROXY_LDFLAGS = /PDB:".\http-proxy.pdb" $(DEF_LIBS)

MOD_TEST_LDFLAGS = /PDB:".\test.pdb" $(DEF_LIBS)


FSV_EXOBJS = *.pdb *.exp *.intermediate.manifest *.lib *.idb

include ./makerules

install: all preinstall
	$(CP) fserv-exec-win.cmd $(RUNDIR)/sbin/fserv.cmd
	$(CP) $(FSV_BIN) $(RUNDIR)/sbin/fserv-bin.exe
	$(CP) ./*_fserv.cmd $(RUNDIR)/
	$(CP) $(FSV_SRCDIR)/../README.txt $(RUNDIR)/

package: install
	mv $(RUNDIR) ../fserv
	cd ..  &&  rm -f fserv-$(VER)-windows-$(TARGET).zip \
		&& $(PACK) fserv-$(VER)-windows-$(TARGET).zip fserv
	mv ../fserv $(RUNDIR)
